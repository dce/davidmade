require 'mustache'
require 'yaml'
require 'rdiscount'

Dir.glob('lib/*.rb').each {|f| require f }

task :build do |t|
  print "Rebuilding... "

  FileUtils.rm_rf("public/posts")
  FileUtils.mkdir("public/posts")

  posts = Post.all
  per_page = 10
  last_page = (posts.size - 1) / per_page

  0.upto(last_page) do |page|
    layout = Layout.new do
      index = Index.new(posts[page * per_page, per_page])
      index[:next_page] = page + 2 unless page == last_page
      index.render
    end

    file_name = page == 0 ? "index" : page + 1

    File.open("public/#{file_name}.html", "w") do |index|
      index.write layout.render
    end
  end

  File.open("public/index.atom", "w") do |feed|
    feed.write Index.new(posts[0, per_page], :format => :atom).render
  end

  puts "done."
end

task :new_post, [:file_name] do |t, args|
  title = args.file_name.split("-").map {|w| w.capitalize } * " "

  File.open("posts/#{args.file_name}.md", "w") do |file|
    file.write "title: \"#{title}\"  \n"
    file.write "date: #{Date.today}\n\n"
  end

  exec "mate posts/#{args.file_name}.md --line 4"
end

task :server do |t|
 sh "cd ./public && python -m SimpleHTTPServer"
end