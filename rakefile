require 'mustache'
require 'yaml'
require 'rdiscount'

class Post < Mustache
  include Comparable

  def initialize(file_path)
    @path = file_path
    @meta, @body = File.open(@path).read.split(/\n\n/, 2)
    @meta = YAML.load(@meta)
    self.template = File.open("templates/_#{type}.html.mustache").read
  end

  def date
    Date.parse(@meta["date"])
  end

  def title
    @meta["title"]
  end

  def file
    @meta["file"]
  end

  def body
    RDiscount.new(@body).to_html if @body
  end

  def type
    @meta["type"] || "post"
  end

  def <=>(other)
    self.date <=> other.date
  end
end

task :build do |t|
  posts = Dir.glob("posts/*").map {|f| Post.new(f) }

  puts Mustache.render(
    File.open("templates/index.html.mustache").read,
    :posts => posts.sort.reverse)
end
